<!DOCTYPE html>
<html>
<head>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/icoder.css') }}">
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/default.min.css') }}">
    <link rel= "stylesheet" type= "text/css" href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <title>Alter Igo: Talk to your Data</title>
</head>
<body>
    <script type=text/javascript src="{{ url_for('static', filename='jquery.js') }}"></script>
    <script type=text/javascript>
        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    </script>
    <script src="{{ url_for('static', filename='highlight.min.js') }}"></script>
    <!--Script for submitting command to python and generating new content-->
    <script type=text/javascript>
        $(document).ready(function(){
            var i=1;
            var nt=0;
            var np=0;
            $('#submit').click(function(){
                $.getJSON($SCRIPT_ROOT + '/process', {
                    command: $('#cmd').val(),
                }, function(data){
                    $('.content').append('<div class="commandwrapper"><div class="numlabel">['+i+']: </div><div class="command_disp"><b>'+data.outputs[1]+'</b></div><div class="feedback-btns"><button class="thumbsup" id="thumbsup'+data.outputs[4]+'" type="button" onclick="positive('+data.outputs[4]+')" title="This worked well"><i class="bx bx-like"></i></button><button class="thumbsdown" id="thumbsdown'+data.outputs[4]+'" type="button" onclick="negative('+data.outputs[4]+')" title="This did not work well"><i class="bx bx-dislike"></i></button></div></div></div>');
                    if (document.getElementById('checkbox').checked) {
                        $('.content').append("<div class='codewrapper'><button data-toggle='collapse' class='cobutton' data-target='#code"+i+"'></button><div class='collapse in' id='code"+i+"'><pre><code class='language-python'>"+data.outputs[2]+"</code></pre></div></div>");
                    } else if (data.outputs[3] == "") {
                        $('.content').append("<div class='codewrapper'><button data-toggle='collapse' class='cobutton' data-target='#code"+i+"'></button><div class='collapse in' id='code"+i+"'><pre><code class='language-python'>"+data.outputs[2]+"</code></pre></div></div>");
                    } else {
                        $('.content').append("<div class='codewrapper'><button data-toggle='collapse' class='cobutton collapsed' data-target='#code"+i+"'></button><div class='collapse' id='code"+i+"'><pre><code class='language-python'>"+data.outputs[2]+"</code></pre></div></div>");
                    }
                    if (data.outputs[0] == 'image') {
                        $('.content').append('<div class="output">'+data.outputs[3]+'</div>');
                        var imgsrc = document.getElementById('image'+np).src;
                        $('.content').append("<div class='dl_btn'><a href="+imgsrc+" download='image"+np+"'>Download as PNG</a></div>");
                        np++;
                    } else if (data.outputs[0] == 'dataframe') {
                        $('.content').append("<div class='output'>"+data.outputs[3]+"</div>");
                        $('.content').append("<div class='dl_btn'><a href='#' onclick='download_table_as_csv("+'table'+nt+");'>Download as CSV</a></div>")
                        nt++;
                    } else if (data.outputs[3] !== "") {
                        $('.content').append('<div class="output"><pre><code class="language-plaintext">'+data.outputs[3]+'</code></pre></div>');
                    }
                    if (data.outputs[2] == '') {
                        alert("Sorry, I couldn't understand your request.");
                    }
                    $('.content').append('<hr>');
                    hljs.highlightAll();
                    document.getElementById("cmd").value = "";
                    $('html,body').animate({scrollTop: document.body.scrollHeight},"fast");
                i++;
            });
            });
        });
    </script>
    <!--Script for clearing content-->
    <script type=text/javascript>
        $(document).ready(function(){
            var i=0;
            $('#clear').click(function(){
                $('.content').empty();
                hljs.highlightAll();
                document.getElementById("cmd").value = "";
            });
        });
    </script>
    <!--checkbox activator-->
    <script type=text/javascript>
        $('#showcode').change(function () {
            if ($(this).is(":checked")) {
                $('#table').show();
            } else {
                $('#table').hide();
            }
        });
    </script>
    <!--Script to trigger submit on Ctrl+Enter, normal linebreak if just Enter-->
    <script type=text/javascript>
        $(document).ready(function(){
            $('#cmd').keydown(function(e){
                if(e.ctrlKey && (e.keyCode == 13 || e.keyCode == 10)) {
                    e.preventDefault();
                    $('#submit').click();
                    document.getElementById("cmd").value = "";
                }
            });
        });
    </script>
    <!--Script for sidebar activation-->
    <script type=text/javascript>
        $(document).ready(function() {
            var sideBar = document.getElementById('entry');
            var arrBtn = document.getElementById('open-close-btn');
            var arrIco = document.getElementById('arrowIcon');
            var hideOnShrink = document.getElementById('entry-main-content');
            var entryTitle = document.getElementById('entry-title');
            var mainDiv = document.getElementById('display');
            $('#open-close-btn').click(function() {
                if (arrIco.classList == "bx bx-arrow-from-right") {
                    arrIco.classList = "bx bx-arrow-from-left";
                    sideBar.style.width = "6rem";
                    hideOnShrink.style.opacity = "0";
                    entryTitle.style.opacity = "0";
                    mainDiv.style.marginLeft = "6rem";
                } else {
                    arrIco.classList = "bx bx-arrow-from-right";
                    sideBar.style.width = "33vw";
                    hideOnShrink.style.opacity = "1";
                    entryTitle.style.opacity = "1";
                    mainDiv.style.marginLeft = "33vw";
                };
            });
        });
    </script>
    <!--Script to download table as csv on button click-->
    <script type=text/javascript>
        function download_table_as_csv(table_id) {
            var rows = document.querySelectorAll('#'+table_id.id+' tr');
            var csv = [];
            for (var i = 0; i < rows.length; i++) {
                var row = [], cols = rows[i].querySelectorAll('td, th');
                for (var j = 0; j < cols.length; j++) {
                    var data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ')
                    data = data.replace(/"/g, '""');
                    // Push escaped string
                    row.push('"' + data + '"');
                }
                csv.push(row.join(','));
            }
            var csv_string = csv.join('\n');

            var filename = 'export_' + table_id.id + '.csv';
            var link = document.createElement('a');
            link.style.display = 'none';
            link.setAttribute('target', '_blank');
            link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv_string));
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
    <!--Script to send button id to positive_feedback for onclick-->
    <script type=text/javascript>
        function positive(button_id) {
            $.getJSON($SCRIPT_ROOT + '/positive_feedback', {
                    db_id: button_id,
                }, function(data) {
                    var elem_up = document.getElementById('thumbsup'+button_id)
                    var elem_dn = document.getElementById('thumbsdown'+button_id)
                    if (elem_up.style.color == 'green') {
                        elem_up.style.color = 'gray';
                    } else {
                        elem_up.style.color = 'green';
                        elem_dn.style.color = 'gray';
                    }
                });
        }
    </script>
    <!--Script to send button id to negative_feedback for onclick-->
    <script type=text/javascript>
        function negative(button_id) {
            $.getJSON($SCRIPT_ROOT + '/negative_feedback', {
                    db_id: button_id,
                }, function(data) {
                    var elem_up = document.getElementById('thumbsup'+button_id)
                    var elem_dn = document.getElementById('thumbsdown'+button_id)
                    if (elem_dn.style.color == 'red') {
                        elem_dn.style.color = 'gray';
                    } else {
                        elem_dn.style.color = 'red';
                        elem_up.style.color = 'gray';
                    }
                });
        }
    </script>
    <!--HTML for body of page-->
    <!--Sidebar that collapses to the left edge-->
    <div class="entry" id="entry">
        <div class="title-close-wrapper">
            <div class="entry-title" id="entry-title">
                <span class="entry-header">
                    <h3>Say what you want in plain English:</h3>
                </span>
            </div>
            <button class="open-close-btn" id="open-close-btn" title="Collapse or expand sidebar">
                <i class="bx bx-arrow-from-right" id="arrowIcon"></i>
            </button>
        </div>
        <div class="entry-main-content" id="entry-main-content">
            <div class="textarea-and-btns">
                <textarea id="cmd" name="cmd" autocomplete="off"></textarea>
                <br>
                <div class="btn-toolbar">
                    <button class="btn btn-primary" id="submit" type="button" title="Submit query (Ctrl+Enter)">
                        <i class="bx bx-right-arrow-alt" id="submit-icon"></i>
                    </button>
                    <button class="btn" id="clear" type="button" title="Clear display">
                        <i class="bx bx-refresh" id="refresh-icon"></i>
                    </button>
                </div>
            </div>
            <br>
            <div>
                <label for="#checkbox" class="checklabelcont">
                    <input type="checkbox" id="checkbox" name="checkbox">
                    <span class="checkbox-label">Show code</span>
                </label>
            </div>
        </div>
    </div>
<!--Main content-->
    <div class="display" id="display">
        <div class="content" id="content"></div>
    </div>
</body>